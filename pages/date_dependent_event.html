<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p3r 情報置き場 日付依存イベント</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>p3r 情報置き場 日付依存イベント</h1>
    このページでは日付依存イベントの情報を漏れなく記録することを目標とする。
    <hr>

    

    <table id="events" class="display">
        <thead>
            <tr>
                <th>日付</th>
                <th>時間</th>
                <th>イベント名称</th>
                <th>勇気変化</th>
                <th>勇気累計</th>
                <th>魅力変化</th>
                <th>魅力累計</th>
                <th>学力変化</th>
                <th>学力累計</th>
            </tr>
            <tr>
                <th><input type="text" placeholder="日付 検索" /></th>
                <th><input type="text" placeholder="時間 検索" /></th>
                <th><input type="text" placeholder="イベント名称 検索" /></th>
                <th><input type="text" placeholder="勇気変化 検索" /></th>
                <th><input type="text" placeholder="勇気累計 検索" /></th>
                <th><input type="text" placeholder="魅力変化 検索" /></th>
                <th><input type="text" placeholder="魅力累計 検索" /></th>
                <th><input type="text" placeholder="学力変化 検索" /></th>
                <th><input type="text" placeholder="学力累計 検索" /></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // CSVファイルの読み込み
        Papa.parse("date_dependent_event.csv", {
            download: true,   // CSVファイルをダウンロード
            header: true,     // ヘッダー行を読み込む
            complete: function(results) {
                var data = results.data;

                table = $('#events').DataTable(
                    {ordering: false}
                );
                table.destroy();

                // DataTablesを初期化
                table = $('#events').DataTable({
                    ordering: false,
                    data: data, // パースされたCSVデータを設定
                    columns: [
                        { data: '日付', type: 'date'},   // CSVの列名に対応
                        { data: '時間' },
                        { data: 'イベント名称' },
                        { data: '勇気変化' },
                        { data: '勇気累計' },
                        { data: '魅力変化' },
                        { data: '魅力累計' },
                        { data: '学力変化' },
                        { data: '学力累計' },
                    ],

                    "footerCallback": function (row, data, start, end, display) {
                        var api = this.api();
                        
                        var courage_total = 0;
                        var attraction_total = 0;
                        var knowledge_total = 0;

                        
                        // 各行をループして累計を計算
                        api.rows({ page: 'current' }).every(function (rowIdx, tableLoop, rowLoop) {
                            var data = this.data();
                            
                            var courage = parseInt(data.勇気変化) || 0;
                            var attraction = parseInt(data.魅力変化) || 0;  
                            var knowledge = parseInt(data.学力変化) || 0; 
                            courage_total += courage;
                            attraction_total += attraction;
                            knowledge_total += knowledge;

                            api.cell(rowIdx, 4).data(courage_total);
                            api.cell(rowIdx, 6).data(attraction_total);
                            api.cell(rowIdx, 8).data(knowledge_total);

                        });
                    },
                    /*
                    "columnDefs": [
                        { "targets": 1, "orderable": false },
                        { "targets": 4, "orderable": false },
                        { "targets": 6, "orderable": false }, 
                        { "targets": 8, "orderable": false } 
                    ]
                    */
                });
            }

            
        });

    </script>

    <script>
    $(document).ready(function() {
        table = $('#events').DataTable(
            {ordering: false}
        );

        // 各列に対して検索を適用
        $('#events thead tr:nth-child(2) th').each(function(index) {
            var that = this;

            // 入力フィールドでフィルタリング
            $('input', this).on('keyup change', function() {
                if (table.column(index).search() !== this.value) {
                    table.column(index).search(this.value).draw();
                }
            });
        });
    });
    </script>


    <div id="footer"></div>
    <script>
    fetch('../include/footer.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('footer').innerHTML = data;
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    </script>

</body>
</html>
